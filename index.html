<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basis Points</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='white'/></svg>">
  <style>
    /* ─── Reset & Variables ─────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d1117;
      --surface:   #161b22;
      --surface2:  #1c2128;
      --border:    #30363d;
      --text:      #e6edf3;
      --muted:     #8b949e;
      --blue:      #58a6ff;
      --green:     #3fb950;
      --red:       #f85149;
      --yellow:    #d29922;
      --a-color:   #58a6ff;
      --b-color:   #3fb950;
      --radius:    8px;
    }

    html { font-size: 15px; scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ─── Header ────────────────────────────────────────────── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-left { display: flex; align-items: center; gap: 1.5rem; }
    .header-title {
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text);
    }
    .header-date  { font-size: 0.7rem; color: var(--muted); }

    /* ─── Main layout ───────────────────────────────────────── */
    main {
      max-width: 1240px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 3rem;
    }

    /* ─── Section labels ────────────────────────────────────── */
    .section-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    /* ─── Portfolio grid ────────────────────────────────────── */
    .portfolio-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 720px) {
      .portfolio-grid { grid-template-columns: 1fr; }
    }

    /* ─── Portfolio card ────────────────────────────────────── */
    .p-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .p-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .p-card.a .p-card-header { border-top: 3px solid var(--a-color); }
    .p-card.b .p-card-header { border-top: 3px solid var(--b-color); }

    .p-name-input {
      background: transparent;
      border: none;
      border-bottom: 1px solid transparent;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
      outline: none;
      width: 160px;
      transition: border-color 0.15s;
    }
    .p-name-input:focus { border-bottom-color: var(--border); }

    .p-actions { display: flex; gap: 0.5rem; align-items: center; }

    select.preset-sel {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.72rem;
      padding: 0.28rem 0.45rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-sm {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.72rem;
      padding: 0.28rem 0.55rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-sm:hover { color: var(--text); border-color: var(--muted); }

    /* ─── ETF rows ──────────────────────────────────────────── */
    .etf-rows { padding: 0.5rem 1.25rem; }

    .etf-class-label {
      padding: 0.5rem 0 0.15rem;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      opacity: 0.6;
    }
    .etf-class-label:first-child { padding-top: 0.1rem; }

    .etf-row {
      display: grid;
      grid-template-columns: 72px 1fr 64px;
      align-items: center;
      gap: 0.75rem;
      padding: 0.45rem 0;
      border-bottom: 1px solid var(--border);
    }
    .etf-row:last-child { border-bottom: none; }

    .etf-ticker-col { line-height: 1.3; }
    .etf-ticker {
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      color: var(--text);
      text-decoration: none;
      border-bottom: 1px dotted var(--border);
      display: inline-block;
      transition: color 0.15s, border-color 0.15s;
    }
    .etf-ticker:hover { color: var(--blue); border-color: var(--blue); }

    /* ─── ETF Modal ──────────────────────────────────────────── */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 1.1rem 1.4rem 0.9rem;
      border-bottom: 1px solid var(--border);
      gap: 0.75rem;
    }
    .modal-ticker { font-size: 1.3rem; font-weight: 800; }
    .modal-name   { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .modal-close  {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      flex-shrink: 0;
    }
    .modal-close:hover { color: var(--text); }
    .modal-desc {
      padding: 0.9rem 1.4rem;
      font-size: 0.75rem;
      color: var(--muted);
      line-height: 1.65;
      border-bottom: 1px solid var(--border);
    }
    .modal-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1px;
      background: var(--border);
      border-bottom: 1px solid var(--border);
    }
    .modal-stat {
      background: var(--surface);
      padding: 0.7rem 1rem;
      text-align: center;
    }
    .modal-stat-val { font-size: 0.92rem; font-weight: 700; font-family: 'SF Mono','Fira Code',monospace; }
    .modal-stat-lbl { font-size: 0.63rem; color: var(--muted); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Range slider */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: var(--border);
      outline: none;
      cursor: pointer;
    }
    .p-card.a input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      border-radius: 50%;
      background: var(--a-color);
      cursor: pointer;
    }
    .p-card.b input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      border-radius: 50%;
      background: var(--b-color);
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; height: 14px;
      border-radius: 50%;
      background: var(--blue);
      cursor: pointer;
      border: none;
    }

    /* Number input */
    input[type="number"].w-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.82rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      padding: 0.28rem 0.4rem;
      border-radius: 4px;
      width: 100%;
      text-align: right;
      -moz-appearance: textfield;
    }
    input[type="number"].w-input::-webkit-inner-spin-button,
    input[type="number"].w-input::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"].w-input:focus {
      outline: none;
      border-color: var(--blue);
    }

    /* ─── Total bar ─────────────────────────────────────────── */
    .p-total-row {
      padding: 0.65rem 1.25rem 0.5rem;
      border-top: 1px solid var(--border);
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .total-lbl  { font-size: 0.72rem; color: var(--muted); }
    .total-val  { font-size: 0.82rem; font-weight: 700; font-family: monospace; }
    .total-val.ok    { color: var(--green); }
    .total-val.over  { color: var(--red); }
    .total-val.under { color: var(--yellow); }

    .alloc-bar-wrap { padding: 0 1.25rem 0.75rem; background: var(--surface2); }
    .alloc-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .alloc-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.2s ease, background 0.2s ease;
    }

    /* ─── Stats section ─────────────────────────────────────── */
    .stats-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .stats-card-header {
      padding: 0.9rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .stats-card-title { font-size: 0.95rem; font-weight: 600; }

    .legend {
      display: flex;
      gap: 1.25rem;
      margin-left: auto;
    }
    .leg-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .leg-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ─── Stat groups & rows ────────────────────────────────── */
    .stat-group-hdr {
      background: var(--surface2);
      padding: 0.4rem 1.5rem;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .stat-row {
      display: grid;
      grid-template-columns: 1fr 90px 200px 90px;
      align-items: center;
      gap: 0.75rem;
      padding: 0.7rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    .stat-row:last-child { border-bottom: none; }

    @media (max-width: 620px) {
      .stat-row {
        grid-template-columns: 1fr 72px 120px 72px;
        gap: 0.5rem;
        padding: 0.65rem 1rem;
      }
    }

    .stat-name { font-size: 0.82rem; }
    .stat-desc { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }

    .stat-val {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.85rem;
      font-weight: 700;
    }
    .stat-val.a { color: var(--a-color); text-align: right; }
    .stat-val.b { color: var(--b-color); text-align: left; }

    /* Butterfly bars */
    .bfly {
      display: flex;
      align-items: center;
      height: 20px;
    }
    .bfly-half {
      flex: 1;
      height: 10px;
      display: flex;
    }
    .bfly-half.left  { justify-content: flex-end; }
    .bfly-half.right { justify-content: flex-start; }
    .bfly-bar {
      height: 100%;
      min-width: 2px;
      transition: width 0.3s ease;
    }
    .bfly-bar.a {
      background: var(--a-color);
      opacity: 0.75;
      border-radius: 3px 0 0 3px;
    }
    .bfly-bar.b {
      background: var(--b-color);
      opacity: 0.75;
      border-radius: 0 3px 3px 0;
    }
    .bfly-ctr {
      width: 2px;
      height: 16px;
      background: var(--border);
      flex-shrink: 0;
    }

    /* Better badge */
    .badge-up {
      display: inline-block;
      font-size: 0.6rem;
      background: rgba(63,185,80,0.15);
      color: var(--green);
      border: 1px solid rgba(63,185,80,0.3);
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 3px;
      vertical-align: middle;
      line-height: 1.4;
    }

    /* ─── Methodology ───────────────────────────────────────── */
    .method-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 1.5rem;
    }
    .method-card summary {
      font-size: 0.82rem;
      font-weight: 600;
      padding: 1rem 1.5rem;
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .method-card summary::-webkit-details-marker { display: none; }
    .method-card summary::before {
      content: '▶';
      font-size: 0.6rem;
      color: var(--muted);
      transition: transform 0.2s;
    }
    .method-card[open] summary::before { transform: rotate(90deg); }
    .method-card summary:hover { color: var(--blue); }
    .method-card-body {
      padding: 0 1.5rem 1.25rem;
      border-top: 1px solid var(--border);
    }
    .method-card p, .method-card li {
      font-size: 0.75rem;
      color: var(--muted);
      line-height: 1.65;
    }
    .method-card p { margin-top: 0.75rem; }
    .method-card ul { padding-left: 1.2rem; margin-top: 0.4rem; }
    .method-card li { margin-bottom: 0.2rem; }
    .method-card strong { color: var(--text); font-weight: 600; }

    /* ─── Empty state ───────────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* ─── Footer ────────────────────────────────────────────── */
    footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.7rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      margin-top: 2rem;
    }

    /* ─── Tooltip ───────────────────────────────────────────── */
    [title] { cursor: help; }

    /* ─── Radar chart ───────────────────────────────────────── */
    .radar-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .radar-body { padding: 1.5rem 1rem; }

    /* ─── Viz Grid (Radar + Growth side by side) ────────────── */
    .viz-grid { display: flex; gap: 1.25rem; align-items: stretch; margin-bottom: 1.5rem; }
    .viz-col  { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .viz-col .radar-card,
    .viz-col .stats-card { margin-bottom: 0; flex: 1; }
    @media (max-width: 800px) { .viz-grid { flex-direction: column; } }

    /* ─── Growth Chart ───────────────────────────────────────── */
    .growth-input-wrap { display: flex; align-items: center; gap: 0.5rem; }
    .growth-mode-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .growth-mode-btn {
      background: var(--surface2);
      border: none;
      color: var(--muted);
      font-size: 0.68rem;
      font-weight: 600;
      font-family: inherit;
      padding: 0.28rem 0.6rem;
      cursor: pointer;
      transition: color 0.15s, background 0.15s;
    }
    .growth-mode-btn + .growth-mode-btn { border-left: 1px solid var(--border); }
    .growth-mode-btn.active { background: var(--surface); color: var(--text); }
    .growth-lbl { font-size: 0.68rem; color: var(--muted); }
    .growth-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      padding: 2px 8px;
      width: 100px;
      text-align: right;
    }
    .growth-summary {
      padding: 0.6rem 1.25rem;
      font-size: 0.78rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      min-height: 2rem;
    }

    /* ─── Tab Navigation ────────────────────────────────────── */
    .tab-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      display: flex;
      gap: 0;
    }
    .tab-btn {
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 0.72rem;
      font-weight: 600;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.7rem 1rem;
      margin-bottom: -1px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .tab-btn:hover  { color: var(--text); }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    .tab-panel          { display: none; }
    .tab-panel.active   { display: block; }

    /* ─── TEY – Fund Cards ──────────────────────────────────── */
    .section-label-note { font-weight: 400; text-transform: none; letter-spacing: 0; font-size: 0.68rem; }
    .tey-fund-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .tey-fund-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem 0.9rem;
    }
    .tey-fund-ticker {
      font-size: 1rem;
      font-weight: 800;
      cursor: pointer;
      display: inline-block;
      border-bottom: 1px dotted var(--border);
      transition: color 0.15s, border-color 0.15s;
    }
    .tey-fund-ticker:hover { color: var(--blue); border-color: var(--blue); }
    .tey-fund-name   { font-size: 0.63rem; color: var(--muted); margin: 3px 0 0.6rem; line-height: 1.4; }
    .tey-badge {
      display: inline-block;
      font-size: 0.58rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 2px 6px;
      border-radius: 3px;
      margin-bottom: 0.7rem;
    }
    .tey-badge.exempt  { background: rgba(63,185,80,0.15);  color: var(--green); border: 1px solid rgba(63,185,80,0.3);  }
    .tey-badge.taxable { background: rgba(248,81,73,0.10);  color: var(--red);   border: 1px solid rgba(248,81,73,0.25); }
    .tey-yield-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.3rem;
    }
    .tey-yield-lbl { font-size: 0.68rem; color: var(--muted); }
    .tey-yield-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.82rem;
      font-weight: 700;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      width: 68px;
      text-align: right;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .tey-yield-input::-webkit-inner-spin-button,
    .tey-yield-input::-webkit-outer-spin-button { -webkit-appearance: none; }
    .tey-yield-input:focus { outline: none; border-color: var(--blue); }
    .tey-er-line { font-size: 0.63rem; color: var(--muted); margin-top: 0.25rem; }

    /* ─── TEY – Fund Groups ─────────────────────────────────── */
    #tey-funds-container { display: flex; gap: 1.5rem; align-items: flex-start; }
    .tey-fund-group { flex: 1; min-width: 0; margin-bottom: 1.25rem; }
    .tey-fund-group-lbl {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }

    /* ─── TEY – Comparison Table ────────────────────────────── */
    .tey-table-wrap { overflow-x: auto; }
    .tey-table { width: 100%; border-collapse: collapse; }
    .tey-table th {
      padding: 0.65rem 1.1rem;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted);
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      text-align: right;
    }
    .tey-table th:first-child { text-align: left; }
    .tey-table th .th-badge {
      display: block;
      font-size: 0.55rem;
      font-weight: 700;
      margin-top: 2px;
      letter-spacing: 0.05em;
    }
    .tey-table th .th-badge.exempt  { color: var(--green); }
    .tey-table th .th-badge.taxable { color: var(--red); }
    .tey-table th.th-group {
      text-align: center;
      font-size: 0.63rem;
      border-right: 1px solid var(--border);
      color: var(--muted);
    }
    .tey-table th.th-group:last-child { border-right: none; }
    .tey-table td.col-group-end { border-right: 1px solid var(--border); }
    .tey-table td {
      padding: 0.7rem 1.1rem;
      border-bottom: 1px solid var(--border);
      text-align: right;
      vertical-align: middle;
    }
    .tey-table tr:last-child td { border-bottom: none; }
    .tey-table td:first-child { text-align: left; }
    .tey-brkt-rate   { font-size: 0.85rem; font-weight: 700; }
    .tey-brkt-income { font-size: 0.63rem; color: var(--muted); margin-top: 2px; }
    .tey-val  { font-family: 'SF Mono','Fira Code',monospace; font-size: 0.85rem; font-weight: 700; }
    .tey-sub  { font-size: 0.62rem; color: var(--muted); margin-top: 2px; }
    .tey-cell-winner .tey-val { color: var(--green); }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="header-title">Basis Points</div>
  </div>
  <div class="header-date">Data · Feb 2026</div>
</header>

<nav class="tab-bar">
  <button class="tab-btn active" data-tab="allocation">Asset Allocation</button>
  <button class="tab-btn"        data-tab="tey">Tax Equivalent Yield</button>
</nav>

<main>

<div id="tab-allocation" class="tab-panel active">

  <!-- ── Portfolios ───────────────────────────────────────────── -->
  <div class="section-label">Portfolios</div>
  <div class="portfolio-grid">

    <!-- Portfolio A -->
    <div class="p-card a" id="card-a">
      <div class="p-card-header">
        <input class="p-name-input" id="name-a" type="text" value="Portfolio A" autocomplete="off" />
        <div class="p-actions">
          <select class="preset-sel" id="preset-a" onchange="applyPreset('a',this.value)">
            <option value="">Presets…</option>
            <option value="2fund">2-Fund (VTI/VXUS 60/40)</option>
            <option value="us_only">100% US (VTI)</option>
            <option value="intl_only">100% International (VXUS)</option>
            <option value="3fund">3-Fund + Small Value</option>
            <option value="avantis_core">Avantis Core (AVGE/AVUV)</option>
            <option value="factor_tilt">Factor Tilted</option>
            <option value="deep_value">Deep Value</option>
            <option value="all_avantis">All Avantis Blend</option>
          </select>
          <button class="btn-sm" onclick="normalizePortfolio('a')">Normalize</button>
        </div>
      </div>
      <div class="etf-rows" id="rows-a"></div>
      <div class="p-total-row">
        <span class="total-lbl">Total Allocation</span>
        <span class="total-val under" id="total-a">0%</span>
      </div>
      <div class="alloc-bar-wrap">
        <div class="alloc-bar">
          <div class="alloc-bar-fill" id="bar-a" style="width:0%;background:var(--a-color)"></div>
        </div>
      </div>
    </div>

    <!-- Portfolio B -->
    <div class="p-card b" id="card-b">
      <div class="p-card-header">
        <input class="p-name-input" id="name-b" type="text" value="Portfolio B" autocomplete="off" />
        <div class="p-actions">
          <select class="preset-sel" id="preset-b" onchange="applyPreset('b',this.value)">
            <option value="">Presets…</option>
            <option value="2fund">2-Fund (VTI/VXUS 60/40)</option>
            <option value="us_only">100% US (VTI)</option>
            <option value="intl_only">100% International (VXUS)</option>
            <option value="3fund">3-Fund + Small Value</option>
            <option value="avantis_core">Avantis Core (AVGE/AVUV)</option>
            <option value="factor_tilt">Factor Tilted</option>
            <option value="deep_value">Deep Value</option>
            <option value="all_avantis">All Avantis Blend</option>
          </select>
          <button class="btn-sm" onclick="normalizePortfolio('b')">Normalize</button>
        </div>
      </div>
      <div class="etf-rows" id="rows-b"></div>
      <div class="p-total-row">
        <span class="total-lbl">Total Allocation</span>
        <span class="total-val under" id="total-b">0%</span>
      </div>
      <div class="alloc-bar-wrap">
        <div class="alloc-bar">
          <div class="alloc-bar-fill" id="bar-b" style="width:0%;background:var(--b-color)"></div>
        </div>
      </div>
    </div>

  </div><!-- /portfolio-grid -->

  <!-- ── Factor Radar + Growth Projection ─────────────────────── -->
  <div class="viz-grid">
    <div class="viz-col">
      <div class="section-label">Factor Profile</div>
      <div class="radar-card">
        <div class="stats-card-header">
          <span class="stats-card-title">Factor Radar</span>
          <div class="legend">
            <div class="leg-item">
              <div class="leg-dot" style="background:var(--a-color)"></div>
              <span id="radar-leg-a">Portfolio A</span>
            </div>
            <div class="leg-item">
              <div class="leg-dot" style="background:var(--b-color)"></div>
              <span id="radar-leg-b">Portfolio B</span>
            </div>
          </div>
        </div>
        <div class="radar-body">
          <svg id="radar-svg" viewBox="0 0 430 350" width="100%" style="max-width:430px;display:block;margin:0 auto"></svg>
        </div>
      </div>
    </div>
    <div class="viz-col">
      <div class="section-label">30-Year Growth Projection <span class="section-label-note">— factor model return, net of fees</span></div>
      <div class="stats-card">
        <div class="stats-card-header">
          <span class="stats-card-title">Projected Portfolio Value</span>
          <div style="display:flex;align-items:center;gap:0.65rem">
            <div class="growth-mode-toggle">
              <button class="growth-mode-btn active" id="mode-nominal" onclick="setGrowthMode('nominal')">Nominal</button>
              <button class="growth-mode-btn"        id="mode-real"    onclick="setGrowthMode('real')">Real</button>
            </div>
            <div class="growth-input-wrap">
              <label class="growth-lbl" for="growth-start">Starting $</label>
              <input class="growth-input" id="growth-start" type="number" min="1000" max="100000000" step="1000" value="1000000" oninput="renderGrowthChart()">
            </div>
          </div>
        </div>
        <svg id="growth-svg" viewBox="0 0 520 300" width="100%" style="display:block"></svg>
        <div id="growth-summary" class="growth-summary"></div>
      </div>
    </div>
  </div>

  <!-- ── Stats comparison ─────────────────────────────────────── -->
  <div class="section-label">Comparison</div>
  <div class="stats-card">
    <div class="stats-card-header">
      <span class="stats-card-title">Portfolio Statistics</span>
      <div class="legend">
        <div class="leg-item">
          <div class="leg-dot" style="background:var(--a-color)"></div>
          <span id="leg-a">Portfolio A</span>
        </div>
        <div class="leg-item">
          <div class="leg-dot" style="background:var(--b-color)"></div>
          <span id="leg-b">Portfolio B</span>
        </div>
      </div>
    </div>
    <div id="stats-body">
      <div class="empty-state">Set allocations in both portfolios above to see comparison.</div>
    </div>
  </div>

  <!-- ── Methodology ──────────────────────────────────────────── -->
  <details class="method-card">
    <summary>Methodology &amp; Data Notes</summary>
    <div class="method-card-body">
      <p>ETF characteristics are approximate values sourced from Vanguard and Avantis fund data as of February 2026.
         All metrics are estimates and should not be used as the sole basis for investment decisions.</p>
      <ul>
        <li><strong>P/E Ratio:</strong> Blended using the harmonic mean (weighted average of earnings yields), which prevents distortion from high-P/E outliers and correctly reflects the aggregate earnings yield of the portfolio.</li>
        <li><strong>Earnings Yield:</strong> 1/PE × 100%. A commonly used simplified proxy for expected real returns over the long run.</li>
        <li><strong>Value Tilt (HML):</strong> Fama-French High-Minus-Low factor loading. 0 ≈ market-cap blend; higher = more tilted toward value stocks.</li>
        <li><strong>Size Tilt (SMB):</strong> Fama-French Small-Minus-Big factor loading. 0 ≈ large-cap weighted; higher = more tilted toward small-cap stocks.</li>
        <li><strong>Factor Model Return Estimate (equities):</strong> = 4.0% (risk-free) + 4.5% (equity market premium) + HML × 3.5% (value premium) + SMB × 2.5% (size premium). Based on historical Fama-French factor research. Factor premiums are not guaranteed to persist in the future.</li>
        <li><strong>Fixed Income Return Estimate (BND):</strong> Uses the current SEC yield as the expected gross return proxy. Blended with the equity factor return proportionally by allocation weight.</li>
        <li><strong>Expense Ratio:</strong> Weighted average annual fund cost. Already subtracted from all return estimates shown.</li>
        <li><strong>Geometric Return &amp; Variance Drag:</strong> The factor model produces an arithmetic mean return. Over time, volatility reduces compounded growth via variance drag: geometric ≈ arithmetic − σ²/2. The 30-year growth projection uses this geometric (CAGR) rate. Portfolio volatility is the weighted average of individual ETF volatilities — a conservative upper bound that ignores diversification benefits.</li>
        <li><strong>This tool is for educational and illustrative purposes only. Not investment advice.</strong></li>
      </ul>
    </div>
  </details>

</div><!-- /tab-allocation -->

<div id="tab-tey" class="tab-panel">

  <!-- ── Bond Funds ───────────────────────────────────────────── -->
  <div class="section-label">Funds <span class="section-label-note">— edit yields to reflect current values</span></div>
  <div id="tey-funds-container"></div>

  <!-- ── Comparison Table ─────────────────────────────────────── -->
  <div class="section-label">After-Tax Yield by Federal Tax Bracket</div>
  <div class="stats-card">
    <div class="tey-table-wrap" id="tey-table"></div>
  </div>

  <!-- ── Methodology ──────────────────────────────────────────── -->
  <details class="method-card">
    <summary>Methodology &amp; Notes</summary>
    <div class="method-card-body">
      <p>Compares the after-tax yield of tax-exempt municipal bond funds against taxable bond funds across federal income tax brackets.</p>
      <ul>
        <li><strong>Tax-Exempt funds (munis):</strong> Interest is exempt from federal income tax. After-tax yield equals the stated yield regardless of bracket.</li>
        <li><strong>Taxable funds:</strong> After-tax yield = stated yield × (1 − marginal rate). Higher brackets erode more of the yield.</li>
        <li><strong>Tax Equivalent Yield (TEY):</strong> The taxable yield needed to match a muni's after-tax yield. TEY = muni yield ÷ (1 − rate). Shown in gray beneath muni values.</li>
        <li><strong>Winner:</strong> The fund with the highest after-tax yield for that bracket is highlighted green.</li>
        <li><strong>State taxes:</strong> Most muni funds are also exempt from state taxes in the issuing state, making them even more attractive in high-tax states. Not modelled here.</li>
        <li><strong>Yields change frequently.</strong> Update the SEC yields above to reflect current data before drawing conclusions.</li>
      </ul>
    </div>
  </details>

</div><!-- /tab-tey -->

</main>

<!-- ── ETF Info Modal ───────────────────────────────────────── -->
<div class="modal-backdrop" id="etf-modal-backdrop" onclick="closeEtfModal(event)">
  <div class="modal" id="etf-modal">
    <div class="modal-header">
      <div>
        <div class="modal-ticker" id="modal-ticker"></div>
        <div class="modal-name"   id="modal-name"></div>
      </div>
      <button class="modal-close" onclick="closeEtfModal()">&times;</button>
    </div>
    <div class="modal-desc" id="modal-desc"></div>
    <div class="modal-stats" id="modal-stats"></div>
  </div>
</div>

<footer>
  Basis Points &nbsp;·&nbsp; Data approximate as of Feb 2026 &nbsp;·&nbsp; Not investment advice
</footer>

<script>
// ================================================================
// ETF DATA
// Source: Vanguard / Avantis fund pages, Morningstar, ETF Database
// Updated: February 2026
// ================================================================
const ETFS = {
  VTI: {
    ticker:    'VTI',
    name:      'Vanguard Total Stock Market ETF',
    sub:       'US Total Market',
    assetClass:'equity',
    pe:        26.0,   // trailing P/E (harmonic mean across holdings)
    pb:        4.00,   // price-to-book, approximate
    intlPct:   0,      // % international (ex-US)
    smb:       0.05,   // Fama-French SMB loading
    hml:       0.00,   // Fama-French HML loading
    er:        0.03,   // expense ratio %
    vol:       16,     // estimated annualized volatility %
    tip:       'Market-cap weighted index covering ~100% of investable US equity market. ~3,525 holdings. No factor tilt.',
  },
  VXUS: {
    ticker:    'VXUS',
    name:      'Vanguard Total International Stock ETF',
    sub:       'International ex-US',
    assetClass:'equity',
    pe:        15.9,
    pb:        1.80,
    intlPct:   97,
    smb:       0.05,
    hml:       0.10,
    er:        0.05,
    vol:       18,
    tip:       'Market-cap weighted index of ~8,700 non-US stocks. ~75% developed, ~25% emerging markets. No active factor tilt.',
  },
  VT: {
    ticker:    'VT',
    name:      'Vanguard Total World Stock ETF',
    sub:       'Global Total Market',
    assetClass:'equity',
    pe:        22.7,
    pb:        3.10,
    intlPct:   40,
    smb:       0.05,
    hml:       0.04,
    er:        0.06,
    vol:       16,
    tip:       'Market-cap weighted index covering ~10,055 stocks across 50+ countries. ~60% US, ~40% international (developed + emerging). No factor tilt. Single-fund global diversification.',
  },
  AVGE: {
    ticker:    'AVGE',
    name:      'Avantis All Equity Markets ETF',
    sub:       'Global · light factor tilts',
    assetClass:'equity',
    pe:        18.5,
    pb:        2.70,
    intlPct:   32,
    smb:       0.20,
    hml:       0.20,
    er:        0.23,
    vol:       17,
    tip:       'Fund-of-funds (~10 Avantis ETFs, ~9,100 underlying securities). Largest holding: AVUS ~41%. Light value, size, and profitability tilts globally.',
  },
  AVGV: {
    ticker:    'AVGV',
    name:      'Avantis All Equity Markets Value ETF',
    sub:       'Global · strong value tilt',
    assetClass:'equity',
    pe:        14.0,
    pb:        1.85,
    intlPct:   40,
    smb:       0.40,
    hml:       0.45,
    er:        0.26,
    vol:       19,
    tip:       'Fund-of-funds (7 Avantis value ETFs). Largest holding: AVLV ~36%. Concentrated in value factors globally with meaningful small cap and profitability tilts.',
  },
  AVUV: {
    ticker:    'AVUV',
    name:      'Avantis U.S. Small Cap Value ETF',
    sub:       'US Small Cap Value',
    assetClass:'equity',
    pe:        13.4,
    pb:        1.75,
    intlPct:   0,
    smb:       0.82,
    hml:       0.60,
    er:        0.25,
    vol:       22,
    tip:       'Actively managed. ~775 holdings selected for low P/B and high profitability. Strong SMB (0.82) and HML (0.60) loadings. ~30% Financials.',
  },
  AVDV: {
    ticker:    'AVDV',
    name:      'Avantis International Small Cap Value ETF',
    sub:       'Intl Small Cap Value',
    assetClass:'equity',
    pe:        14.1,
    pb:        1.05,
    intlPct:   99,
    smb:       0.78,
    hml:       0.35,
    er:        0.36,
    vol:       22,
    tip:       'Actively managed international small cap value. ~1,686 holdings across developed markets ex-US. Strong SMB (0.78) and HML (0.35) loadings. Complements AVUV for a global SCV allocation.',
  },
  BND: {
    ticker:    'BND',
    name:      'Vanguard Total Bond Market ETF',
    sub:       'US Investment-Grade Bonds',
    assetClass:'fixed',
    bondYield: 4.18,   // SEC yield — drives expected return
    pe:        null,   // N/A for bonds
    pb:        null,   // N/A for bonds
    intlPct:   0,
    smb:       0,
    hml:       0,
    er:        0.03,
    vol:       5,
    tip:       'Tracks the Bloomberg U.S. Aggregate Bond Index. ~17,000 investment-grade US bonds — Treasuries (~45%), agencies, and corporates. Duration ~6 years. Broad core bond exposure. Fully taxable interest; best held in tax-advantaged accounts.',
  },
};

const TICKERS = ['VTI', 'VXUS', 'VT', 'AVGE', 'AVGV', 'AVUV', 'AVDV', 'BND'];

// ================================================================
// PRESETS
// ================================================================
const PRESETS = {
  '2fund':        { VTI:60, VXUS:40, VT:0,   AVGE:0,  AVGV:0,  AVUV:0,  AVDV:0,  BND:0  },
  'us_only':      { VTI:100,VXUS:0,  VT:0,   AVGE:0,  AVGV:0,  AVUV:0,  AVDV:0,  BND:0  },
  'intl_only':    { VTI:0,  VXUS:100,VT:0,   AVGE:0,  AVGV:0,  AVUV:0,  AVDV:0,  BND:0  },
  '3fund':        { VTI:50, VXUS:30, VT:0,   AVGE:0,  AVGV:0,  AVUV:20, AVDV:0,  BND:0  },
  'avantis_core': { VTI:0,  VXUS:0,  VT:0,   AVGE:60, AVGV:0,  AVUV:40, AVDV:0,  BND:0  },
  'factor_tilt':  { VTI:0,  VXUS:20, VT:0,   AVGE:20, AVGV:0,  AVUV:40, AVDV:20, BND:0  },
  'deep_value':   { VTI:0,  VXUS:0,  VT:0,   AVGE:0,  AVGV:50, AVUV:50, AVDV:0,  BND:0  },
  'all_avantis':  { VTI:0,  VXUS:0,  VT:0,   AVGE:40, AVGV:30, AVUV:20, AVDV:10, BND:0  },
};

// ================================================================
// STATE — default portfolios give a useful starting comparison
// ================================================================
const state = {
  a: { VTI:42, VXUS:18, VT:0, AVGE:0, AVGV:0, AVUV:14, AVDV:6, BND:20 },
  b: { VTI:0,  VXUS:0,  VT:80,AVGE:0, AVGV:0, AVUV:0,  AVDV:0, BND:20 },
};

// ================================================================
// BUILD PORTFOLIO INPUT ROWS
// ================================================================
function buildRows(p) {
  const container = document.getElementById(`rows-${p}`);
  container.innerHTML = '';
  let lastClass = null;
  TICKERS.forEach(tk => {
    const etf = ETFS[tk];
    const v   = state[p][tk] ?? 0;

    // Section divider when asset class changes
    if (etf.assetClass !== lastClass) {
      const lbl = document.createElement('div');
      lbl.className = 'etf-class-label';
      lbl.textContent = etf.assetClass === 'equity' ? 'Equities' : 'Fixed Income';
      container.appendChild(lbl);
      lastClass = etf.assetClass;
    }

    const row = document.createElement('div');
    row.className = 'etf-row';
    row.innerHTML = `
      <div class="etf-ticker-col">
        <span class="etf-ticker" onclick="openEtfModal('${tk}')">${tk}</span>
      </div>
      <input type="range" min="0" max="100" step="1" value="${v}"
        id="sl-${p}-${tk}"
        oninput="onSlider('${p}','${tk}',this.value)">
      <input type="number" class="w-input" min="0" max="100" step="1" value="${v}"
        id="nu-${p}-${tk}"
        oninput="onNumber('${p}','${tk}',this.value)">
    `;
    container.appendChild(row);
  });
}

// ================================================================
// INPUT HANDLERS
// ================================================================
function onSlider(p, tk, raw) {
  const v = Math.max(0, Math.min(100, parseFloat(raw) || 0));
  state[p][tk] = v;
  const num = document.getElementById(`nu-${p}-${tk}`);
  if (num) num.value = v;
  refreshTotal(p);
  renderAll();
}

function onNumber(p, tk, raw) {
  const v = Math.max(0, Math.min(100, parseFloat(raw) || 0));
  state[p][tk] = v;
  const sl = document.getElementById(`sl-${p}-${tk}`);
  if (sl) sl.value = v;
  refreshTotal(p);
  renderAll();
}

function applyPreset(p, key) {
  if (!key || !PRESETS[key]) return;
  const preset = PRESETS[key];
  TICKERS.forEach(tk => {
    state[p][tk] = preset[tk] ?? 0;
    const sl = document.getElementById(`sl-${p}-${tk}`);
    const nu = document.getElementById(`nu-${p}-${tk}`);
    if (sl) sl.value = state[p][tk];
    if (nu) nu.value = state[p][tk];
  });
  document.getElementById(`preset-${p}`).value = '';
  refreshTotal(p);
  renderAll();
}

function normalizePortfolio(p) {
  const total = TICKERS.reduce((s,tk) => s + (state[p][tk]||0), 0);
  if (total === 0) return;
  TICKERS.forEach(tk => {
    state[p][tk] = Math.round((state[p][tk]||0) / total * 100);
  });
  // Correct rounding drift
  const newTotal = TICKERS.reduce((s,tk) => s + state[p][tk], 0);
  if (newTotal !== 100) {
    const largest = TICKERS.reduce((a,b) => state[p][a] >= state[p][b] ? a : b);
    state[p][largest] += (100 - newTotal);
  }
  TICKERS.forEach(tk => {
    const sl = document.getElementById(`sl-${p}-${tk}`);
    const nu = document.getElementById(`nu-${p}-${tk}`);
    if (sl) sl.value = state[p][tk];
    if (nu) nu.value = state[p][tk];
  });
  refreshTotal(p);
  renderAll();
}

// ================================================================
// TOTAL BAR
// ================================================================
function refreshTotal(p) {
  const total = TICKERS.reduce((s,tk) => s + (state[p][tk]||0), 0);
  const valEl = document.getElementById(`total-${p}`);
  const barEl = document.getElementById(`bar-${p}`);
  valEl.textContent = `${total}%`;
  valEl.className   = 'total-val ' + (total === 100 ? 'ok' : total > 100 ? 'over' : 'under');
  const fill = Math.min(total, 100);
  barEl.style.width      = `${fill}%`;
  const colorOk  = p === 'a' ? 'var(--a-color)' : 'var(--b-color)';
  barEl.style.background = total === 100 ? colorOk : total > 100 ? 'var(--red)' : 'var(--yellow)';
}

// ================================================================
// CALC PORTFOLIO STATS
// ================================================================
const RF   = 4.0;   // risk-free rate %
const MKT  = 4.5;   // equity market premium %
const VPREM = 3.5;  // value premium per unit HML %
const SPREM = 2.5;  // size premium per unit SMB %

function calcStats(p) {
  const w     = state[p];
  const total = TICKERS.reduce((s,tk) => s + (w[tk]||0), 0);
  if (total === 0) return null;

  let eySum       = 0;  // portfolio-weighted earnings yields (equity ETFs only)
  let pbSum       = 0;  // portfolio-weighted P/B (equity ETFs only)
  let intlPct     = 0;
  let smb         = 0;
  let hml         = 0;
  let er          = 0;
  let equityW     = 0;  // fraction of portfolio in equity ETFs
  let bondRet     = 0;  // portfolio-weighted bond yield contribution
  let portfolioVol = 0; // weighted-average annualized volatility %

  TICKERS.forEach(tk => {
    const frac = (w[tk]||0) / total;
    const e    = ETFS[tk];
    er           += frac * e.er;
    intlPct      += frac * e.intlPct;
    smb          += frac * e.smb;
    hml          += frac * e.hml;
    portfolioVol += frac * e.vol;
    if (e.assetClass === 'fixed') {
      bondRet += frac * e.bondYield;
    } else {
      equityW += frac;
      eySum   += frac * (1 / e.pe);
      pbSum   += frac * e.pb;
    }
  });

  // PE and PB are for the equity sleeve only (null if no equities)
  const pe            = equityW > 0 ? equityW / eySum : null;
  const pb            = equityW > 0 ? pbSum / equityW : null;
  const earningsYield = eySum * 100;  // portfolio-level equity earnings yield contribution

  // Equity factor return (per unit invested in equities), then blended with bond yield
  const equityHML   = equityW > 0 ? hml / equityW : 0;
  const equitySMB   = equityW > 0 ? smb / equityW : 0;
  const equityRet   = RF + MKT + equityHML * VPREM + equitySMB * SPREM;
  const factorReturn    = equityW * equityRet + bondRet;  // bondRet already portfolio-weighted
  const factorReturnNet = factorReturn - er;
  // Geometric return ≈ arithmetic − σ²/2  (variance drag; σ in %, so divide by 200)
  const geometricReturnNet = factorReturnNet - (portfolioVol * portfolioVol) / 200;
  const earningsYieldNet = earningsYield - er;
  const costDrag30 = 1000000 * (Math.pow(1 + factorReturn / 100, 30) - Math.pow(1 + factorReturnNet / 100, 30));

  return { pe, pb, earningsYield, earningsYieldNet, intlPct, smb, hml, er, factorReturn, factorReturnNet, portfolioVol, geometricReturnNet, costDrag30, total, equityW };
}

// ================================================================
// STAT DEFINITIONS
// ================================================================
const STAT_GROUPS = [
  {
    label: 'Valuation',
    stats: [
      {
        key:    'pe',
        name:   'P/E Ratio',
        desc:   'Harmonic mean P/E · equity sleeve only',
        tip:    'Harmonic mean P/E of the equity sleeve (bond allocations excluded). Lower = cheaper relative to earnings.',
        fmt:    v => v == null ? '—' : v.toFixed(1) + 'x',
        better: 'lower',
      },
      {
        key:    'pb',
        name:   'P/B Ratio',
        desc:   'Weighted avg P/B · equity sleeve only',
        tip:    'Weighted average price-to-book of the equity sleeve (bond allocations excluded). Lower = more value exposure.',
        fmt:    v => v == null ? '—' : v.toFixed(2) + 'x',
        better: 'lower',
      },
    ],
  },
  {
    label: 'Factor Exposures',
    stats: [
      {
        key:    'hml',
        name:   'Value Tilt (HML)',
        desc:   'Fama-French High-Minus-Low loading',
        tip:    'HML factor loading. 0 = market blend. Higher = more tilted toward value stocks. AVUV ~0.55, VTI ~0.00.',
        fmt:    v => v.toFixed(2),
        better: 'neutral',
      },
      {
        key:    'smb',
        name:   'Size Tilt (SMB)',
        desc:   'Fama-French Small-Minus-Big loading',
        tip:    'SMB factor loading. 0 = large-cap. Higher = more small-cap. AVUV ~0.95, VTI ~0.05.',
        fmt:    v => v.toFixed(2),
        better: 'neutral',
      },
    ],
  },
  {
    label: 'Geographic Exposure',
    stats: [
      {
        key:    'intlPct',
        name:   'International Allocation',
        desc:   'Weighted % in ex-US markets',
        tip:    'Percentage of portfolio in non-US markets (developed + emerging). VXUS = 97%, VTI = 0%.',
        fmt:    v => v.toFixed(1) + '%',
        better: 'neutral',
      },
    ],
  },
  {
    label: 'Expected Return Estimates (Model)',
    stats: [
      {
        key:    'factorReturnNet',
        name:   'Arithmetic Return (Factor)',
        desc:   `${RF}% RF + ${MKT}% MKT + HML×${VPREM}% + SMB×${SPREM}% − ER`,
        tip:    `Fama-French arithmetic mean return net of fees. RF=${RF}%, Market premium=${MKT}%, Value premium=${VPREM}%/unit HML, Size premium=${SPREM}%/unit SMB, minus blended expense ratio. This is the arithmetic average — it overstates compounded growth because it ignores volatility drag.`,
        fmt:    v => v.toFixed(2) + '%',
        better: 'higher',
      },
      {
        key:    'portfolioVol',
        name:   'Est. Volatility (σ)',
        desc:   'Weighted-avg annualized std. deviation',
        tip:    'Weighted average of individual ETF annualized volatilities. This is a conservative upper bound — actual portfolio vol is lower due to diversification, but correlations are omitted here.',
        fmt:    v => v.toFixed(1) + '%',
        better: 'neutral',
      },
      {
        key:    'geometricReturnNet',
        name:   'Geometric Return (est.)',
        desc:   'Arithmetic return − σ²/2 · used for growth chart',
        tip:    'Estimated compound annual growth rate (CAGR), accounting for variance drag: geometric ≈ arithmetic − σ²/2. This is the rate used in the 30-year growth projection. Lower volatility portfolios benefit more from this correction.',
        fmt:    v => v.toFixed(2) + '%',
        better: 'higher',
      },
      {
        key:    'earningsYieldNet',
        name:   'Earnings Yield (net)',
        desc:   'Earnings yield minus expense ratio',
        tip:    'Earnings yield (1/PE × 100%) after subtracting the blended expense ratio. Rough long-run real return proxy for the equity sleeve.',
        fmt:    v => v.toFixed(2) + '%',
        better: 'higher',
      },
    ],
  },
  {
    label: 'Cost',
    stats: [
      {
        key:    'er',
        name:   'Expense Ratio',
        desc:   'Weighted avg annual fund cost',
        tip:    'Blended weighted-average expense ratio. Subtract from expected returns for net estimates.',
        fmt:    v => v.toFixed(3) + '%',
        better: 'lower',
      },
      {
        key:    'costDrag30',
        name:   '30-yr ER Drag',
        desc:   'Fee cost on $1M over 30 years (compounded)',
        tip:    'How much the expense ratio reduces terminal wealth on a $1,000,000 investment over 30 years, assuming the factor model gross return holds. Lower is better.',
        fmt:    v => '$' + Math.round(v).toLocaleString(),
        better: 'lower',
      },
    ],
  },
];

// ================================================================
// RENDER RADAR CHART
// ================================================================
function renderRadar() {
  const sa = calcStats('a');
  const sb = calcStats('b');

  const nameA = document.getElementById('name-a').value.trim() || 'Portfolio A';
  const nameB = document.getElementById('name-b').value.trim() || 'Portfolio B';
  document.getElementById('radar-leg-a').textContent = nameA;
  document.getElementById('radar-leg-b').textContent = nameB;

  const svg = document.getElementById('radar-svg');
  if (!svg) return;

  if (!sa && !sb) {
    svg.innerHTML = `<text x="215" y="175" text-anchor="middle" dominant-baseline="middle" font-size="13" fill="var(--muted)">Set allocations above to see chart.</text>`;
    return;
  }

  const cx = 213, cy = 175, R = 120;
  const FONT = "-apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif";

  // Axes: top=Earnings Yield, right=Int'l %, bottom=Size SMB, left=Value HML
  const AXES = [
    { key: 'earningsYield', label: 'Earnings Yield', max: 9.0,  angle: -Math.PI / 2 },
    { key: 'intlPct',       label: "Int'l %",         max: 100,  angle: 0 },
    { key: 'smb',           label: 'Size (SMB)',       max: 1.0,  angle: Math.PI / 2 },
    { key: 'hml',           label: 'Value (HML)',      max: 0.65, angle: Math.PI },
  ];

  const RINGS = [0.25, 0.5, 0.75, 1.0];

  function pt(angle, frac) {
    return [cx + frac * R * Math.cos(angle), cy + frac * R * Math.sin(angle)];
  }

  function labelStyle(angle) {
    const EPS = 0.01;
    if (Math.abs(angle) < EPS)                          return { anchor: 'start',  baseline: 'middle' };
    if (Math.abs(Math.abs(angle) - Math.PI) < EPS)     return { anchor: 'end',    baseline: 'middle' };
    if (angle < 0)                                       return { anchor: 'middle', baseline: 'auto' };
    return                                                      { anchor: 'middle', baseline: 'hanging' };
  }

  let s = '';

  // Grid rings
  RINGS.forEach((f, i) => {
    const pts = AXES.map(a => pt(a.angle, f).map(v => v.toFixed(1)).join(',')).join(' ');
    const outer = i === RINGS.length - 1;
    s += `<polygon points="${pts}" fill="${outer ? 'rgba(255,255,255,0.02)' : 'none'}" stroke="var(--border)" stroke-width="${outer ? 1.5 : 1}" opacity="${outer ? 0.9 : 0.4}"/>`;
  });

  // Axis lines
  AXES.forEach(ax => {
    const [x, y] = pt(ax.angle, 1);
    s += `<line x1="${cx}" y1="${cy}" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="var(--border)" stroke-width="1" opacity="0.6"/>`;
  });

  // Center dot
  s += `<circle cx="${cx}" cy="${cy}" r="2" fill="var(--border)" opacity="0.5"/>`;

  // Portfolio polygon
  function drawPortfolio(stats, color) {
    if (!stats) return '';
    const pts = AXES.map(ax => {
      const frac = Math.min(Math.max((stats[ax.key] ?? 0) / ax.max, 0), 1);
      return pt(ax.angle, frac).map(v => v.toFixed(1)).join(',');
    }).join(' ');
    let out = `<polygon points="${pts}" fill="${color}" fill-opacity="0.12" stroke="${color}" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;
    AXES.forEach(ax => {
      const frac = Math.min(Math.max((stats[ax.key] ?? 0) / ax.max, 0), 1);
      const [dx, dy] = pt(ax.angle, frac);
      out += `<circle cx="${dx.toFixed(1)}" cy="${dy.toFixed(1)}" r="4" fill="${color}" stroke="var(--bg)" stroke-width="1.5"/>`;
    });
    return out;
  }

  // Draw B first so A renders on top
  s += drawPortfolio(sb, 'var(--b-color)');
  s += drawPortfolio(sa, 'var(--a-color)');

  // Axis labels
  const GAP = 18;
  AXES.forEach(ax => {
    const lx = cx + (R + GAP) * Math.cos(ax.angle);
    const ly = cy + (R + GAP) * Math.sin(ax.angle);
    const { anchor, baseline } = labelStyle(ax.angle);
    s += `<text x="${lx.toFixed(1)}" y="${ly.toFixed(1)}" text-anchor="${anchor}" dominant-baseline="${baseline}" font-size="10.5" fill="var(--muted)" font-family="${FONT}">${ax.label}</text>`;
  });

  svg.innerHTML = s;
}

// ================================================================
// GROWTH CHART MODE
// ================================================================
const INFLATION = 2.5;  // assumed annual inflation %
let growthMode = 'nominal';

function setGrowthMode(mode) {
  growthMode = mode;
  document.getElementById('mode-nominal').classList.toggle('active', mode === 'nominal');
  document.getElementById('mode-real').classList.toggle('active', mode === 'real');
  renderGrowthChart();
}

// ================================================================
// RENDER STATS
// ================================================================
function renderGrowthChart() {
  const svg     = document.getElementById('growth-svg');
  const summary = document.getElementById('growth-summary');
  const sA = calcStats('a');
  const sB = calcStats('b');

  const empty = msg => {
    svg.innerHTML = `<text x="260" y="150" text-anchor="middle" dominant-baseline="middle" font-size="13" fill="var(--muted)">${msg}</text>`;
    summary.innerHTML = '';
  };

  if (!sA || !sB || sA.total < 99 || sB.total < 99) {
    return empty('Set allocations above to see projection.');
  }

  const START = Math.max(1000, parseFloat(document.getElementById('growth-start').value) || 1000000);
  const YEARS = 30;
  const isReal = growthMode === 'real';
  const inflAdj = isReal ? (1 + INFLATION / 100) : 1;

  // Use geometric return (arithmetic − σ²/2) as the compounding rate
  // Real rate = (1 + nominal) / (1 + inflation) - 1
  const rA = (1 + sA.geometricReturnNet / 100) / inflAdj - 1;
  const rB = (1 + sB.geometricReturnNet / 100) / inflAdj - 1;

  const dataA = Array.from({ length: YEARS + 1 }, (_, y) => START * Math.pow(1 + rA, y));
  const dataB = Array.from({ length: YEARS + 1 }, (_, y) => START * Math.pow(1 + rB, y));

  const vW = 520, vH = 300;
  const PAD = { top: 18, right: 80, bottom: 36, left: 62 };
  const plotW = vW - PAD.left - PAD.right;
  const plotH = vH - PAD.top - PAD.bottom;

  const maxVal = Math.max(...dataA, ...dataB);
  const xS = y => PAD.left + (y / YEARS) * plotW;
  const yS = v => PAD.top + plotH - (v / maxVal) * plotH;

  const fmt = v => {
    if (v >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M';
    if (v >= 1e3) return '$' + Math.round(v / 1e3) + 'k';
    return '$' + Math.round(v);
  };

  const pathFor = data =>
    data.map((v, y) => `${y === 0 ? 'M' : 'L'}${xS(y).toFixed(1)},${yS(v).toFixed(1)}`).join(' ');

  // Y-axis ticks (5 evenly spaced)
  const nTicks = 4;
  let out = '';
  for (let i = 0; i <= nTicks; i++) {
    const v = (i / nTicks) * maxVal;
    const y = yS(v).toFixed(1);
    out += `<line x1="${PAD.left}" y1="${y}" x2="${PAD.left + plotW}" y2="${y}" stroke="var(--border)" stroke-width="1"/>`;
    out += `<text x="${PAD.left - 6}" y="${y}" text-anchor="end" dominant-baseline="middle" font-size="10" fill="var(--muted)">${fmt(v)}</text>`;
  }

  // X-axis ticks
  [0, 10, 20, 30].forEach(yr => {
    const x = xS(yr).toFixed(1);
    const yBase = (PAD.top + plotH).toFixed(1);
    out += `<line x1="${x}" y1="${yBase}" x2="${x}" y2="${(PAD.top + plotH + 4).toFixed(1)}" stroke="var(--border)" stroke-width="1"/>`;
    out += `<text x="${x}" y="${(PAD.top + plotH + 14).toFixed(1)}" text-anchor="middle" font-size="10" fill="var(--muted)">${yr === 0 ? 'Now' : `Yr ${yr}`}</text>`;
  });

  // Lines
  out += `<path d="${pathFor(dataA)}" fill="none" stroke="var(--a-color)" stroke-width="2.5" stroke-linejoin="round"/>`;
  out += `<path d="${pathFor(dataB)}" fill="none" stroke="var(--b-color)" stroke-width="2.5" stroke-linejoin="round"/>`;

  // End-of-line value labels
  const endA = dataA[YEARS], endB = dataB[YEARS];
  const yEndA = yS(endA).toFixed(1), yEndB = yS(endB).toFixed(1);
  const xEnd  = (PAD.left + plotW + 5).toFixed(1);
  out += `<text x="${xEnd}" y="${yEndA}" dominant-baseline="middle" font-size="10" font-weight="600" fill="var(--a-color)">${fmt(endA)}</text>`;
  out += `<text x="${xEnd}" y="${yEndB}" dominant-baseline="middle" font-size="10" font-weight="600" fill="var(--b-color)">${fmt(endB)}</text>`;

  svg.innerHTML = out;

  // Summary callout
  const nameA = document.getElementById('name-a').value.trim() || 'Portfolio A';
  const nameB = document.getElementById('name-b').value.trim() || 'Portfolio B';
  const diff = Math.abs(endA - endB);
  const rateA = (rA * 100).toFixed(2), rateB = (rB * 100).toFixed(2);
  const modeNote = isReal ? ` real (${INFLATION}% infl.)` : ' nominal';
  const dragNote = `geometric return, variance drag applied`;
  if (diff < 1) {
    summary.innerHTML = `Both portfolios project the same terminal value — ${dragNote}${modeNote}.`;
  } else {
    const winner = endA > endB ? nameA : nameB;
    const color  = endA > endB ? 'var(--a-color)' : 'var(--b-color)';
    const dollarNote = isReal ? ' in today\'s dollars' : '';
    summary.innerHTML = `<strong style="color:${color}">${winner}</strong> projects <strong>${fmt(diff)} more</strong> after 30 years${dollarNote} — ${fmt(START)} starting, ${rateA}% vs ${rateB}%${modeNote} CAGR (${dragNote}).`;
  }
}

function renderAll() {
  renderRadar();
  renderGrowthChart();

  const sa = calcStats('a');
  const sb = calcStats('b');

  const nameA = document.getElementById('name-a').value.trim() || 'Portfolio A';
  const nameB = document.getElementById('name-b').value.trim() || 'Portfolio B';
  document.getElementById('leg-a').textContent = nameA;
  document.getElementById('leg-b').textContent = nameB;

  const body = document.getElementById('stats-body');

  if (!sa || !sb) {
    body.innerHTML = '<div class="empty-state">Set allocations in both portfolios above to see comparison.</div>';
    return;
  }

  let html = '';

  STAT_GROUPS.forEach(grp => {
    html += `<div class="stat-group-hdr">${grp.label}</div>`;
    grp.stats.forEach(def => {
      const va = sa[def.key];
      const vb = sb[def.key];

      // Butterfly bar widths (each half max 90px); treat null as 0
      const vaNum = va ?? 0;
      const vbNum = vb ?? 0;
      const maxV = Math.max(Math.abs(vaNum), Math.abs(vbNum), 0.001);
      const pctA = (vaNum / maxV) * 90;
      const pctB = (vbNum / maxV) * 90;

      // Better badge (skip if either value is null)
      let badgeA = '', badgeB = '';
      if (def.better !== 'neutral' && va != null && vb != null && Math.abs(va - vb) > 0.0005) {
        const aWins = def.better === 'higher' ? va > vb : va < vb;
        if (aWins) badgeA = '<span class="badge-up">↑</span>';
        else        badgeB = '<span class="badge-up">↑</span>';
      }

      html += `
        <div class="stat-row" title="${def.tip}">
          <div>
            <div class="stat-name">${def.name}</div>
            <div class="stat-desc">${def.desc}</div>
          </div>
          <div class="stat-val a">${def.fmt(va)}${badgeA}</div>
          <div class="bfly">
            <div class="bfly-half left">
              <div class="bfly-bar a" style="width:${pctA}px"></div>
            </div>
            <div class="bfly-ctr"></div>
            <div class="bfly-half right">
              <div class="bfly-bar b" style="width:${pctB}px"></div>
            </div>
          </div>
          <div class="stat-val b">${def.fmt(vb)}${badgeB}</div>
        </div>
      `;
    });
  });

  body.innerHTML = html;
}

// ================================================================
// MODAL
// ================================================================
function openModal(ticker, name, tip, stats) {
  document.getElementById('modal-ticker').textContent = ticker;
  document.getElementById('modal-name').textContent   = name;
  document.getElementById('modal-desc').textContent   = tip;
  document.getElementById('modal-stats').innerHTML = stats
    .map(s => `<div class="modal-stat"><div class="modal-stat-val">${s.val}</div><div class="modal-stat-lbl">${s.lbl}</div></div>`)
    .join('');
  document.getElementById('etf-modal-backdrop').classList.add('open');
}

function closeEtfModal(e) {
  if (e && e.target !== document.getElementById('etf-modal-backdrop')) return;
  document.getElementById('etf-modal-backdrop').classList.remove('open');
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('etf-modal-backdrop').classList.remove('open');
});

function openEtfModal(tk) {
  const etf = ETFS[tk];
  const isFixed = etf.assetClass === 'fixed';
  openModal(tk, etf.name, etf.tip, [
    isFixed ? { val: etf.bondYield.toFixed(2) + '%', lbl: 'SEC Yield'   }
            : { val: etf.pe.toFixed(1) + 'x',        lbl: 'P/E Ratio'   },
    isFixed ? { val: '—',                             lbl: 'P/B Ratio'   }
            : { val: etf.pb.toFixed(2) + 'x',        lbl: 'P/B Ratio'   },
    isFixed ? { val: '—',                             lbl: 'Earn. Yield' }
            : { val: (100/etf.pe).toFixed(2) + '%',  lbl: 'Earn. Yield' },
    { val: etf.smb.toFixed(2),      lbl: 'SMB'        },
    { val: etf.hml.toFixed(2),      lbl: 'HML'        },
    { val: etf.intlPct + '%',       lbl: "Int'l %"    },
    { val: etf.er.toFixed(3) + '%', lbl: 'Exp. Ratio' },
  ]);
}

function openTeyModal(i) {
  const f = TEY_FUNDS[i];
  openModal(f.ticker, f.name, f.tip, [
    { val: f.yield.toFixed(2) + '%',   lbl: f.category === 'mmf' ? '7-Day Yield' : 'SEC Yield' },
    { val: f.er.toFixed(2) + '%',      lbl: 'Exp. Ratio'     },
    { val: f.taxExempt ? 'Yes' : 'No', lbl: 'Fed Tax-Exempt' },
    { val: f.category === 'etf' ? 'Bond ETF' : 'Money Market', lbl: 'Type' },
  ]);
}

// ================================================================
// TAB SWITCHING
// ================================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

// ================================================================
// TAX EQUIVALENT YIELD TOOL
// ================================================================
const TEY_FUNDS = [
  { ticker: 'VTEB',  name: 'Vanguard Tax-Exempt Bond ETF',        yield: 3.36, taxExempt: true,  er: 0.05, category: 'etf', tip: 'Broad national municipal bond ETF. Interest is exempt from federal income tax. Holds ~8,000 investment-grade muni bonds. Duration ~5 years. Suitable for taxable accounts at higher brackets.' },
  { ticker: 'BND',   name: 'Vanguard Total Bond Market ETF',       yield: 4.18, taxExempt: false, er: 0.03, category: 'etf', tip: ETFS.BND.tip },
  { ticker: 'VMSXX', name: 'Vanguard Municipal Money Market Fund', yield: 2.42, taxExempt: true,  er: 0.15, category: 'mmf', tip: 'Money market fund investing in short-term municipal securities. Interest is exempt from federal income tax. NAV targets $1.00. Suited for high-bracket investors parking cash in taxable accounts.' },
  { ticker: 'VMFXX', name: 'Vanguard Federal Money Market Fund',   yield: 3.76, taxExempt: false, er: 0.11, category: 'mmf', tip: 'Vanguard\'s default settlement fund. Invests in US government securities and repos. Yield tracks the fed funds rate. Interest is fully taxable at ordinary income rates.' },
];

const TEY_BRACKETS = [
  { rate: 10, label: '10%', income: 'Up to $23,200 MFJ'         },
  { rate: 12, label: '12%', income: '$23,201 – $94,300 MFJ'     },
  { rate: 22, label: '22%', income: '$94,301 – $201,050 MFJ'    },
  { rate: 24, label: '24%', income: '$201,051 – $383,900 MFJ'   },
  { rate: 32, label: '32%', income: '$383,901 – $487,450 MFJ'   },
  { rate: 35, label: '35%', income: '$487,451 – $731,200 MFJ'   },
  { rate: 37, label: '37%', income: 'Over $731,200 MFJ'         },
];

function buildTeyFundCards() {
  const container = document.getElementById('tey-funds-container');
  container.innerHTML = '';

  const groups = [
    { key: 'etf', label: 'Bond ETFs' },
    { key: 'mmf', label: 'Money Market Funds' },
  ];

  groups.forEach(grp => {
    const funds = TEY_FUNDS.filter(f => f.category === grp.key);
    const group = document.createElement('div');
    group.className = 'tey-fund-group';
    group.innerHTML = `<div class="tey-fund-group-lbl">${grp.label}</div>`;

    const grid = document.createElement('div');
    grid.className = 'tey-fund-grid';

    funds.forEach(f => {
      const i = TEY_FUNDS.indexOf(f);
      const badgeCls = f.taxExempt ? 'exempt' : 'taxable';
      const badgeTxt = f.taxExempt ? 'Tax-Exempt' : 'Taxable';
      const yieldLbl = grp.key === 'mmf' ? '7-Day Yield' : 'SEC Yield';
      const card = document.createElement('div');
      card.className = 'tey-fund-card';
      card.innerHTML = `
        <div class="tey-fund-ticker" onclick="openTeyModal(${i})">${f.ticker}</div>
        <div class="tey-fund-name">${f.name}</div>
        <div class="tey-badge ${badgeCls}">${badgeTxt}</div>
        <div class="tey-yield-row">
          <span class="tey-yield-lbl">${yieldLbl}</span>
          <input class="tey-yield-input" type="number" min="0" max="20" step="0.01"
            value="${f.yield.toFixed(2)}"
            oninput="onTeyYield(${i}, this.value)">
        </div>
        <div class="tey-er-line">ER: ${f.er.toFixed(2)}%</div>
      `;
      grid.appendChild(card);
    });

    group.appendChild(grid);
    container.appendChild(group);
  });
}

function onTeyYield(i, raw) {
  const v = Math.max(0, Math.min(20, parseFloat(raw) || 0));
  TEY_FUNDS[i].yield = v;
  renderTeyTable();
}

function renderTeyTable() {
  const wrap = document.getElementById('tey-table');

  // Header — two rows: group labels, then fund columns
  const etfFunds = TEY_FUNDS.filter(f => f.category === 'etf');
  const mmfFunds = TEY_FUNDS.filter(f => f.category === 'mmf');

  let html = '<table class="tey-table"><thead>';
  html += '<tr>';
  html += '<th rowspan="2">Federal Bracket</th>';
  html += `<th colspan="${etfFunds.length}" class="th-group">Bond ETFs</th>`;
  html += `<th colspan="${mmfFunds.length}" class="th-group">Money Market Funds</th>`;
  html += '</tr><tr>';
  TEY_FUNDS.forEach(f => {
    const badgeCls = f.taxExempt ? 'exempt' : 'taxable';
    const badgeTxt = f.taxExempt ? 'Tax-Exempt' : 'Taxable';
    html += `<th>${f.ticker}<span class="th-badge ${badgeCls}">${badgeTxt} · ${f.yield.toFixed(2)}%</span></th>`;
  });
  html += '</tr></thead><tbody>';

  // Rows
  TEY_BRACKETS.forEach(brkt => {
    const rate = brkt.rate / 100;

    // Compute after-tax yield for each fund
    const afterTax = TEY_FUNDS.map(f =>
      f.taxExempt ? f.yield : f.yield * (1 - rate)
    );

    // Find winner per category independently
    const catWinner = {};
    ['etf', 'mmf'].forEach(cat => {
      const catEntries = TEY_FUNDS.map((f, i) => ({ i, at: afterTax[i] })).filter((_, i) => TEY_FUNDS[i].category === cat);
      const max = Math.max(...catEntries.map(e => e.at));
      catWinner[cat] = catEntries.find(e => e.at === max).i;
    });

    html += '<tr>';
    html += `<td><div class="tey-brkt-rate">${brkt.label}</div><div class="tey-brkt-income">${brkt.income}</div></td>`;

    TEY_FUNDS.forEach((f, i) => {
      const at        = afterTax[i];
      const isW       = catWinner[f.category] === i;
      const isLastEtf = f.category === 'etf' && (TEY_FUNDS[i + 1]?.category === 'mmf');
      const tey = f.taxExempt ? (f.yield / (1 - rate)) : null;
      const sub = f.taxExempt
        ? `<div class="tey-sub">TEY: ${tey.toFixed(2)}%</div>`
        : `<div class="tey-sub">after ${brkt.label} tax</div>`;
      const cls = [isW ? 'tey-cell-winner' : '', isLastEtf ? 'col-group-end' : ''].join(' ').trim();
      html += `<td class="${cls}">
        <div class="tey-val">${at.toFixed(2)}%</div>${sub}
      </td>`;
    });

    html += '</tr>';
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;
}

// ================================================================
// INIT
// ================================================================
function init() {
  buildRows('a');
  buildRows('b');
  refreshTotal('a');
  refreshTotal('b');
  renderAll();

  document.getElementById('name-a').addEventListener('input', renderAll);
  document.getElementById('name-b').addEventListener('input', renderAll);

  buildTeyFundCards();
  renderTeyTable();
}

init();
</script>
</body>
</html>
